# SessionManager & FileWriter Documentation (JarvisAgent)

## Overview

`SessionManager` coordinates end‑to‑end processing of a single automation session.  
It monitors file changes, rebuilds the environment, schedules API queries, tracks responses, and publishes session status locally (terminal) and remotely (websocket).

`FileWriter` is a thread‑safe utility for writing output files and generated results.

---

# SessionManager

## Responsibilities

- Monitor settings/context/task files
- Assemble combined “environment” text
- Detect requirement changes
- Dispatch API queries for modified requirement files
- Track inflight queries and parse replies
- Write `.output.*` files
- Update UI (terminal + web dashboard)
- Maintain a per‑session state machine

---

## State Machine

### States
```
CompilingEnvironment
SendingQueries
AllQueriesSent
AllResponsesReceived
```

### Inputs (StateInfo)
- `m_EnvironmentChanged`
- `m_EnvironmentComplete`
- `m_QueriesChanged`
- `m_AllQueriesSent`
- `m_AllResponsesReceived`

### Behavior Summary
- Build environment → move to **SendingQueries**
- All modified requirements dispatched → **AllQueriesSent**
- All futures resolved → **AllResponsesReceived**
- Any new changes → state resets accordingly

---

## Core Operations

### OnUpdate()

1. **CheckForUpdates()**
   - Rebuild `m_Settings`, `m_Context`, `m_Tasks`
   - Reassemble environment if needed
   - Mark requirements modified when environment changes

2. **TrackInFlightQueries()**
   - Remove completed futures
   - Emit engine events on errors

3. **StateMachine Update**
   - Transition between the four states based on conditions

4. **Dispatch Pending Queries**
   - Limit queue to *1.5 × maxThreads*
   - For each modified requirement, run `DispatchQuery()` if needed

5. **Status Output**
   - Update terminal `StatusRenderer`
   - Broadcast state to WebServer over `/ws`

---

### IsQueryRequired(TrackedFile&)
Checks timestamps:
- Requirement missing → skip
- Output missing → required
- Requirement/env newer than output → required  
Else: skip.

---

### DispatchQuery()
- Assemble prompt = environment + file content
- JSON‑escape via `JsonHelper::SanitizeForJson`
- Choose API format depending on `InterfaceType`
- Submit async curl job to thread pool
- On completion:
  - Parse reply via `ReplyParser`
  - Write `.output.*` files using `FileWriter`
  - Log results and propagate engine errors as needed

---

### Environment Assembly

`Environment::Assemble(settings, context, tasks, categorized)`:

- If any part is empty → mark environment incomplete
- Combine all parts
- Compare with previous version
- If changed:
  - Update timestamp
  - Mark dirty
- Set `m_EnvironmentComplete = true`

`GetEnvironmentAndResetDirtyFlag()`  
Returns combined environment and clears the dirty flag.

---

### Handling File Events

`OnEvent(Event&)` processes:
- `FileAddedEvent`
- `FileModifiedEvent`
- `FileRemovedEvent`

Using `FileCategorizer`, it updates tracked files and their dirty flags.

---

### IsIdle()
Idle when state machine is in `AllResponsesReceived`.

---

# FileWriter

## Overview

Thread‑safe file output helper.  
Used by `SessionManager` when writing `.output.*` files.

---

## Write(path, content)
- Lock guard
- Create directories
- Truncate + write file
- Log success/error

---

## WriteWithHeader(path, content, model, appendTimestamp)
Writes a structured output:

```
# Generated by JarvisAgent
# Model: <model>
# Timestamp: <optional>
<content>
```

- Lock guard
- Safe directory creation
- Logs operations and exceptions

---

# Summary

`SessionManager` drives the automation loop for a session:
- File monitoring
- Incremental rebuild of environment
- Selective re‑querying based on timestamps
- Async curl integration
- Managed state machine
- UI + WebSocket reporting

`FileWriter` provides safe file emission for generated results.

Together, these components form the core orchestration path from file change → environment rebuild → API query → output generation in JarvisAgent.
